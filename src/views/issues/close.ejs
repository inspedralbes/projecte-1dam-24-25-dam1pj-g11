<!-- src/views/issues/close.ejs -->
<%- include('../partials/header', { title: 'Incidencia' }) %>

<div class="row">
  <div class="col-lg-10 offset-lg-1">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Incidencia #<%= issue.id %></h2>
        <span class="badge <%= issue.status === 'open' ? 'bg-danger' : 
                              issue.status === 'in_progress' ? 'bg-warning' : 'bg-success' %> fs-6">
          <%= issue.status === 'open' ? 'Abierta' : 
             issue.status === 'in_progress' ? 'En proceso' : 'Cerrada' %>
        </span>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-8">
            <h4><%= issue.title %></h4>
            <p><%= issue.description %></p>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-light">Detalles</div>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Departamento:</span>
                  <span class="fw-bold"><%= issue.Department ? issue.Department.name : 'N/A' %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Creada por:</span>
                  <span class="fw-bold"><%= issue.Creator ? issue.Creator.fullName : 'N/A' %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Fecha creación:</span>
                  <span class="fw-bold"><%= new Date(issue.creationDate).toLocaleDateString() %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Tipo:</span>
                  <span class="fw-bold">
                    <%= issue.type === 'hardware' ? 'Hardware' : 
                       issue.type === 'software' ? 'Software' : 
                       issue.type === 'network' ? 'Red' : 'Otro' %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Prioridad:</span>
                  <span class="badge <%= issue.priority === 'urgent' ? 'bg-danger' : 
                                        issue.priority === 'high' ? 'bg-warning text-dark' : 
                                        issue.priority === 'medium' ? 'bg-info text-dark' : 'bg-light text-dark' %>">
                    <%= issue.priority === 'urgent' ? 'Urgente' : 
                       issue.priority === 'high' ? 'Alta' : 
                       issue.priority === 'medium' ? 'Media' : 'Baja' %>
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Actuaciones -->
        <h4>Actuaciones</h4>
        <% if (issue.Actions && issue.Actions.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Descripción</th>
                  <th>Tiempo (min)</th>
                </tr>
              </thead>
              <tbody>
                <% issue.Actions.forEach(action => { %>
                  <tr>
                    <td><%= new Date(action.date).toLocaleString() %></td>
                    <td><%= action.description %></td>
                    <td><%= action.timeSpent || '0' %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info">No hay actuaciones registradas todavía</div>
        <% } %>
        
        <div class="mt-4 d-flex justify-content-between">
          <div>
            <a href="/actions/create/<%= issue.id %>" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Añadir Actuación
            </a>
          </div>
          
          <% if (issue.status !== 'closed') { %>
            <form action="/issues/<%= issue.id %>/close" method="POST" onsubmit="return confirm('¿Seguro que quieres cerrar esta incidencia?');">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check2-circle"></i> Cerrar Incidencia
              </button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="d-grid gap-2 col-6 mx-auto">
      <a href="/issues" class="btn btn-outline-secondary">Volver al Listado</a>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
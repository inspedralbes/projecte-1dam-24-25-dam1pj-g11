<!-- src/views/issues/track.ejs -->
<%- include('../partials/header', { title: 'Seguimiento de Incidencia' }) %>

<div class="row">
  <div class="col-lg-8 offset-lg-2">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Seguimiento de su Incidencia</h2>
      </div>
      <div class="card-body">
        <% if (error) { %>
          <div class="alert alert-danger"><%= error %></div>
        <% } %>
        
        <form action="/issues/track" method="POST" class="mb-4">
          <div class="input-group">
            <input type="number" class="form-control" name="issueId" placeholder="Introduzca el número de incidencia" required>
            <button class="btn btn-primary" type="submit">Buscar</button>
          </div>
        </form>
        
        <% if (issue) { %>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h4 class="mb-0">Incidencia #<%= issue.id %></h4>
              <span class="badge <%= issue.status === 'open' ? 'bg-danger' : 
                                  issue.status === 'in_progress' ? 'bg-warning' : 'bg-success' %> fs-6">
                <%= issue.status === 'open' ? 'Abierta' : 
                  issue.status === 'in_progress' ? 'En proceso' : 'Cerrada' %>
              </span>
            </div>
            <div class="card-body">
              <h5><%= issue.title %></h5>
              <p><%= issue.description %></p>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <p><strong>Departamento:</strong> <%= issue.Department ? issue.Department.name : 'N/A' %></p>
                  <p><strong>Tipo:</strong> 
                    <%= issue.type === 'hardware' ? 'Hardware' : 
                       issue.type === 'software' ? 'Software' : 
                       issue.type === 'network' ? 'Red' : 'Otro' %>
                  </p>
                </div>
                <div class="col-md-6">
                  <p><strong>Fecha creación:</strong> <%= new Date(issue.creationDate).toLocaleDateString() %></p>
                  <p><strong>Prioridad:</strong> 
                    <span class="badge <%= issue.priority === 'urgent' ? 'bg-danger' : 
                                         issue.priority === 'high' ? 'bg-warning text-dark' : 
                                         issue.priority === 'medium' ? 'bg-info text-dark' : 'bg-light text-dark' %>">
                      <%= issue.priority === 'urgent' ? 'Urgente' : 
                         issue.priority === 'high' ? 'Alta' : 
                         issue.priority === 'medium' ? 'Media' : 'Baja' %>
                    </span>
                  </p>
                </div>
              </div>
              
              <h5 class="mt-4">Historial de actuaciones:</h5>
              <% if (issue.Actions && issue.Actions.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>Actuación</th>
                        <th>Técnico</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% issue.Actions.forEach(action => { %>
                        <tr>
                          <td><%= new Date(action.date).toLocaleString() %></td>
                          <td><%= action.description %></td>
                          <td><%= action.Technician ? action.Technician.fullName : 'N/A' %></td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="alert alert-info">No hay actuaciones registradas todavía</div>
              <% } %>
              
              <% if (issue.status === 'closed') { %>
                <div class="alert alert-success mt-3">
                  <strong>Incidencia resuelta</strong> - Fecha de cierre: <%= new Date(issue.closingDate).toLocaleDateString() %>
                </div>
              <% } %>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>